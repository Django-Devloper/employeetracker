<!-- streamlit_template.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Embedded Streamlit App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>
    <div class="container">
         <div class="row">
            <div class="col-4">
                <div class="card" style="min-height: 600px !important">
                    <div class="card-header">
                        <div class="row">
                            <div class="col h5">Chat History</div>
                            <div class="col-2">
                                <button type="submit" class="btn btn-primary" id="new_chat"><i class="fa-solid fa-pen-to-square"></i></button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body"></div>

                </div>
            </div>

            <div class="col ">
                <div class="card" style="min-height: 600px !important">
                    <div class="h5 card-header">Chat</div>
                        <div class="card-body flex-grow-1 overflow-auto">
                            <p id="chat_messages"></p>
                        </div>
                        <div class="card-footer">
                            <form >
                                <div class="form-group">
                                    <div class="row">
                                        <div class="col">
                                            <input type="text"  id="chat_detail" placeholder="Ask anything..." class="form-control">
                                        </div>
                                        <div class="col-1">
                                            <button type="submit" id="send_button" class="btn btn-primary"><i class="fa-solid fa-paper-plane"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
            </div>
        </div>

    </div>

</body>
<script src="https://code.jquery.com/jquery-3.7.1.slim.min.js" integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
<script>
    let ws; // Declare ws variable globally to access it across functions
    const ws_path = (group) => {
        const host = window.location.host;
        const path = `ws://${host}/path/${group}/`;
        return path;
    };

    const new_ws = (path) => {
        ws = new WebSocket(path); // Establish a new WebSocket connection

        ws.onopen = (event) => {
            console.log("WebSocket connection established");
        };

        ws.onmessage = (event) => {
            console.log("Received message:", event.data);
            $("#chat_messages").text(event.data)
        };

        ws.onclose = (event) => {
            console.log("Connection closed");
        };

        ws.onerror = (event) => {
            console.error("WebSocket error:", event);
        };
    };

    $('#new_chat').on('click', function () {
        const now = new Date();
        const timestampKey = now.getFullYear().toString() +
            (now.getMonth() + 1).toString().padStart(2, '0') +
            now.getDate().toString().padStart(2, '0') +
            now.getHours().toString().padStart(2, '0') +
            now.getMinutes().toString().padStart(2, '0') +
            now.getSeconds().toString().padStart(2, '0');

        console.log("Timestamp Key:", timestampKey);
        const path = ws_path(timestampKey);

        // Close any existing WebSocket connection before creating a new one
        if (ws) {
            ws.close();
        }

        new_ws(path);
    });

    $('#send_button').on('click', function (e) {
        e.preventDefault();
        console.log("Send button clicked");

        const question = $('#chat_detail').val();
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(question);
            console.log("Message sent:", question);
        } else {
            console.error("WebSocket is not open. Unable to send message.");
        }
    });

</script>

</html>
